"use strict";var Ne=Object.defineProperty;var Re=(l,t,n)=>t in l?Ne(l,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):l[t]=n;var T=(l,t,n)=>(Re(l,typeof t!="symbol"?t+"":t,n),n);var ee=Object.defineProperty,te=(l,t,n)=>t in l?ee(l,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):l[t]=n,M=(l,t,n)=>(te(l,typeof t!="symbol"?t+"":t,n),n),re=(l=>(l.ThemeFrom_Blog="zhi-theme-blog",l.ThemeFrom_Siyuan="zhi-theme-siyuan",l))(re||{}),ne=Object.defineProperty,oe=(l,t,n)=>t in l?ne(l,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):l[t]=n,a=(l,t,n)=>(oe(l,typeof t!="symbol"?t+"":t,n),n),ie=Object.defineProperty,se=(l,t,n)=>t in l?ie(l,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):l[t]=n,U=(l,t,n)=>(se(l,typeof t!="symbol"?t+"":t,n),n),X=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},x={},ae={get exports(){return x},set exports(l){x=l}};(function(l){(function(t,n){l.exports?l.exports=n():t.log=n()})(X,function(){var t=function(){},n="undefined",c=typeof window!==n&&typeof window.navigator!==n&&/Trident\/|MSIE /.test(window.navigator.userAgent),u=["trace","debug","info","warn","error"];function h(f,A){var F=f[A];if(typeof F.bind=="function")return F.bind(f);try{return Function.prototype.bind.call(F,f)}catch{return function(){return Function.prototype.apply.apply(F,[f,arguments])}}}function g(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function m(f){return f==="debug"&&(f="log"),typeof console===n?!1:f==="trace"&&c?g:console[f]!==void 0?h(console,f):console.log!==void 0?h(console,"log"):t}function S(f,A){for(var F=0;F<u.length;F++){var E=u[F];this[E]=F<f?t:this.methodFactory(E,f,A)}this.log=this.debug}function d(f,A,F){return function(){typeof console!==n&&(S.call(this,A,F),this[f].apply(this,arguments))}}function p(f,A,F){return m(f)||d.apply(this,arguments)}function y(f,A,F){var E=this,Ue;A=A??"WARN";var D="loglevel";typeof f=="string"?D+=":"+f:typeof f=="symbol"&&(D=void 0);function Te(w){var C=(u[w]||"silent").toUpperCase();if(!(typeof window===n||!D)){try{window.localStorage[D]=C;return}catch{}try{window.document.cookie=encodeURIComponent(D)+"="+C+";"}catch{}}}function _e(){var w;if(!(typeof window===n||!D)){try{w=window.localStorage[D]}catch{}if(typeof w===n)try{var C=window.document.cookie,W=C.indexOf(encodeURIComponent(D)+"=");W!==-1&&(w=/^([^;]+)/.exec(C.slice(W))[1])}catch{}return E.levels[w]===void 0&&(w=void 0),w}}function De(){if(!(typeof window===n||!D)){try{window.localStorage.removeItem(D);return}catch{}try{window.document.cookie=encodeURIComponent(D)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}E.name=f,E.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},E.methodFactory=F||p,E.getLevel=function(){return Ue},E.setLevel=function(w,C){if(typeof w=="string"&&E.levels[w.toUpperCase()]!==void 0&&(w=E.levels[w.toUpperCase()]),typeof w=="number"&&w>=0&&w<=E.levels.SILENT){if(Ue=w,C!==!1&&Te(w),S.call(E,w,f),typeof console===n&&w<E.levels.SILENT)return"No console available for logging"}else throw"log.setLevel() called with invalid level: "+w},E.setDefaultLevel=function(w){A=w,_e()||E.setLevel(w,!1)},E.resetLevel=function(){E.setLevel(A,!1),De()},E.enableAll=function(w){E.setLevel(E.levels.TRACE,w)},E.disableAll=function(w){E.setLevel(E.levels.SILENT,w)};var B=_e();B==null&&(B=A),E.setLevel(B,!1)}var L=new y,_={};L.getLogger=function(f){if(typeof f!="symbol"&&typeof f!="string"||f==="")throw new TypeError("You must supply a name when creating a logger.");var A=_[f];return A||(A=_[f]=new y(f,L.getLevel(),L.methodFactory)),A};var q=typeof window!==n?window.log:void 0;return L.noConflict=function(){return typeof window!==n&&window.log===L&&(window.log=q),L},L.getLoggers=function(){return _},L.default=L,L})})(ae);var k={},le={get exports(){return k},set exports(l){k=l}};(function(l){(function(t,n){l.exports?l.exports=n():t.prefix=n(t)})(X,function(t){var n=function(p){for(var y=1,L=arguments.length,_;y<L;y++)for(_ in arguments[y])Object.prototype.hasOwnProperty.call(arguments[y],_)&&(p[_]=arguments[y][_]);return p},c={template:"[%t] %l:",levelFormatter:function(p){return p.toUpperCase()},nameFormatter:function(p){return p||"root"},timestampFormatter:function(p){return p.toTimeString().replace(/.*(\d{2}:\d{2}:\d{2}).*/,"$1")},format:void 0},u,h={},g=function(p){if(!p||!p.getLogger)throw new TypeError("Argument is not a root logger");u=p},m=function(p,y){if(!p||!p.setLevel)throw new TypeError("Argument is not a logger");var L=p.methodFactory,_=p.name||"",q=h[_]||h[""]||c;function f(A,F,E){var Ue=L(A,F,E),D=h[E]||h[""],Te=D.template.indexOf("%t")!==-1,_e=D.template.indexOf("%l")!==-1,De=D.template.indexOf("%n")!==-1;return function(){for(var B="",w=arguments.length,C=Array(w),W=0;W<w;W++)C[W]=arguments[W];if(_||!h[E]){var ke=D.timestampFormatter(new Date),Ve=D.levelFormatter(A),xe=D.nameFormatter(E);D.format?B+=D.format(Ve,xe,ke):(B+=D.template,Te&&(B=B.replace(/%t/,ke)),_e&&(B=B.replace(/%l/,Ve)),De&&(B=B.replace(/%n/,xe))),C.length&&typeof C[0]=="string"?C[0]=B+" "+C[0]:C.unshift(B)}Ue.apply(void 0,C)}}return h[_]||(p.methodFactory=f),y=y||{},y.template&&(y.format=void 0),h[_]=n({},q,y),p.setLevel(p.getLevel()),u||p.warn("It is necessary to call the function reg() of loglevel-plugin-prefix before calling apply. From the next release, it will throw an error. See more: https://github.com/kutuluk/loglevel-plugin-prefix/blob/master/README.md"),p},S={reg:g,apply:m},d;return t&&(d=t.prefix,S.noConflict=function(){return t.prefix===S&&(t.prefix=d),S}),S})})(le);class N{}U(N,"LOG_LEVEL_KEY","VITE_LOG_LEVEL"),U(N,"LOG_PREFIX_KEY","VITE_LOG_PREFIX");var O=(l=>(l.LOG_LEVEL_DEBUG="DEBUG",l.LOG_LEVEL_INFO="INFO",l.LOG_LEVEL_WARN="WARN",l.LOG_LEVEL_ERROR="ERROR",l))(O||{});function ce(){const l=Error.prepareStackTrace;Error.prepareStackTrace=(n,c)=>c;const t=new Error().stack.slice(1);return Error.prepareStackTrace=l,t}class R{static stringToEnumValue(t,n){return t[Object.keys(t).filter(c=>t[c].toString()===n)[0]]}static getEnvLevel(t){if(!t)return;const n=t.getEnvOrDefault(N.LOG_LEVEL_KEY,O.LOG_LEVEL_INFO),c=R.stringToEnumValue(O,n.toUpperCase());return c||console.warn("[zhi-log] LOG_LEVEL is invalid in you .env file.Must be either debug, info, warn or error, fallback to default info level"),c}static getEnvLogger(t){if(t)return t.getEnv(N.LOG_PREFIX_KEY)}}class ue{constructor(t,n,c){U(this,"consoleLogger","console"),U(this,"stackSize",1),U(this,"getLogger",g=>{let m;if(g)m=g;else{const S=ce(),d=[],p=[];for(let y=0;y<S.length;y++){const L=S[y],_=L.getFileName()??"none";if(y>this.stackSize-1)break;const q=_+"-"+L.getLineNumber()+":"+L.getColumnNumber();d.push(q)}p.length>0&&(m=d.join(" -> "))}return(!m||m.trim().length===0)&&(m=this.consoleLogger),x.getLogger(m)}),this.stackSize=1;let u;t?u=t:u=R.getEnvLevel(c),u=u??O.LOG_LEVEL_INFO,x.setLevel(u);const h={gray:g=>g.toString(),green:g=>g.toString(),yellow:g=>g.toString(),red:g=>g.toString()};k.reg(x),k.apply(x,{format(g,m,S){const d=["["+(n??R.getEnvLogger(c)??"zhi")+"]"];switch(d.push(h.gray("[")+h.green(S).toString()+h.gray("]")),g){case O.LOG_LEVEL_DEBUG:d.push(h.gray(g.toUpperCase().toString()));break;case O.LOG_LEVEL_INFO:d.push(h.green(g.toUpperCase().toString()));break;case O.LOG_LEVEL_WARN:d.push(h.yellow(g.toUpperCase().toString()));break;case O.LOG_LEVEL_ERROR:d.push(h.red(g.toUpperCase().toString()));break}return d.push(h.green(m).toString()),d.push(h.gray(":")),d.join(" ")}})}setStackSize(t){this.stackSize=t??1}}class he{constructor(t,n,c){U(this,"logger"),this.logger=new ue(t,n,c)}getLogger(t,n){return this.logger.setStackSize(n),this.logger.getLogger(t)}}class Z extends he{constructor(t,n,c){super(t,n,c)}getLogger(t,n){return super.getLogger(t,n)}}class j{static defaultLogger(t,n){return j.customLogFactory(void 0,void 0,t).getLogger(void 0,n)}static customLogFactory(t,n,c){return new Z(t,n,c)}static customSignLogFactory(t,n){return new Z(void 0,t,n)}}class J{}a(J,"LOG_STACK_SIZE",1);const Q="1.0.11";class ge{constructor(){a(this,"VERSION"),this.VERSION=Q}}class pe{constructor(){a(this,"VERSION"),this.VERSION=Q}}const I=class{constructor(){a(this,"getQueryString",l=>{if(!I.isInBrowser)return"";const t=window.location.search.substring(1).split("&");for(let n=0;n<t.length;n++){const c=t[n].split("=");if(c[0]===l)return c[1]}return""})}static isInChromeExtension(){return I.isInBrowser?window.location.href.indexOf("chrome-extension://")>-1:!1}};let b=I;a(b,"isInBrowser",typeof window<"u"),a(b,"isElectron",()=>!I.isInBrowser||!window.navigator||!window.navigator.userAgent?!1:/Electron/.test(window.navigator.userAgent)),a(b,"replaceUrlParam",(l,t,n)=>{n==null&&(n="");const c=new RegExp("\\b("+t+"=).*?(&|#|$)");return l.search(c)>=0?l.replace(c,"$1"+n+"$2"):(l=l.replace(/[?#]$/,""),l+(l.indexOf("?")>0?"&":"?")+t+"="+n)}),a(b,"setUrlParameter",(l,t,n)=>I.isInBrowser?l.includes(t)?I.replaceUrlParam(l,t,n):(l+=(l.match(/[?]/g)!=null?"&":"?")+t+"="+n,l):""),a(b,"reloadTabPage",l=>{setTimeout(function(){if(I.isInBrowser){const t=window.location.href;window.location.href=I.setUrlParameter(t,"tab",l)}},200)}),a(b,"reloadPage",()=>{setTimeout(function(){I.isInBrowser&&window.location.reload()},200)}),a(b,"reloadPageWithMessageCallback",(l,t)=>{t&&t(),setTimeout(function(){I.isInBrowser&&window.location.reload()},200)});class G{constructor(){a(this,"isInSiyuanWidget",()=>typeof window>"u"?!1:window.frameElement!=null&&window.frameElement.parentElement!=null&&window.frameElement.parentElement.parentElement!=null&&window.frameElement.parentElement.parentElement.getAttribute("data-node-id")!==""),a(this,"isInSiyuanNewWin",()=>typeof window>"u"?!1:typeof window.terwer<"u"),a(this,"isInSiyuanOrSiyuanNewWin",()=>b.isElectron)}siyuanWindow(){let t;return this.isInSiyuanWidget()?t=parent.window:this.isInSiyuanNewWin()||typeof window<"u"?t=window:t=void 0,t}}class fe{constructor(){a(this,"serverApi"),a(this,"clientApi"),a(this,"siyuanUtil"),this.serverApi=new ge,this.clientApi=new pe,this.siyuanUtil=new G}}class de{constructor(){a(this,"VERSION"),this.VERSION="1.0.0"}}class we{f(t,...n){let c=t;for(let u=0;u<n.length;u++){const h=n[u];typeof h=="string"?c=c.replace(`{${u}}`,h):c=c.replace(`{${u}}`,h.toString())}return c}}class ye{constructor(){a(this,"TIME_SPLIT"," "),a(this,"formatIsoToZhDate",(t,n,c)=>{if(!t)return"";let u=t;const h=/(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})(.\d{3})Z$/gm,g=u.match(h);if(g==null)return t;for(let m=0;m<g.length;m++){const S=g[m];let d=S;n&&(d=this.addHoursToDate(new Date(S),8).toISOString());const p=d.split("T"),y=p[0],L=p[1].split(".")[0];let _=y+this.TIME_SPLIT+L;c&&(_=y),u=u.replace(S,_)}return u})}addHoursToDate(t,n){return t.setTime(t.getTime()+n*60*60*1e3),t}nowZh(){return this.formatIsoToZhDate(new Date().toISOString())}nowDateZh(){return this.formatIsoToZhDate(new Date().toISOString(),!0,!0)}nowTimeZh(){return this.formatIsoToZhDate(new Date().toISOString(),!0).split(this.TIME_SPLIT)[1]}}const z=(l,t)=>{const n=$(l),c=$(t),u=n.pop(),h=c.pop(),g=H(n,c);return g!==0?g:u&&h?H(u.split("."),h.split(".")):u||h?u?-1:1:0},me=/^[v^~<>=]*?(\d+)(?:\.([x*]|\d+)(?:\.([x*]|\d+)(?:\.([x*]|\d+))?(?:-([\da-z\-]+(?:\.[\da-z\-]+)*))?(?:\+[\da-z\-]+(?:\.[\da-z\-]+)*)?)?)?$/i,$=l=>{if(typeof l!="string")throw new TypeError("Invalid argument expected string");const t=l.match(me);if(!t)throw new Error(`Invalid argument not valid semver ('${l}' received)`);return t.shift(),t},K=l=>l==="*"||l==="x"||l==="X",Y=l=>{const t=parseInt(l,10);return isNaN(t)?l:t},ve=(l,t)=>typeof l!=typeof t?[String(l),String(t)]:[l,t],Le=(l,t)=>{if(K(l)||K(t))return 0;const[n,c]=ve(Y(l),Y(t));return n>c?1:n<c?-1:0},H=(l,t)=>{for(let n=0;n<Math.max(l.length,t.length);n++){const c=Le(l[n]||"0",t[n]||"0");if(c!==0)return c}return 0};class Ee{greater(t,n){return z(t,n)>0}equal(t,n){return z(t,n)===0}lesser(t,n){return z(t,n)<0}}class Se{static getDevice(){const t=new G;return t.isInSiyuanWidget()?"Siyuan_Widget":t.isInSiyuanOrSiyuanNewWin()?"Siyuan_NewWin":b.isInChromeExtension()?"Chrome_Extension":"Chrome_Browser"}}class be{constructor(){a(this,"siyuanUtil"),a(this,"requireLib",t=>{const n=this.siyuanUtil.siyuanWindow();return n?n.require(t):require(t)}),a(this,"getCrossPlatformAppDataFolder",()=>{var t,n,c,u,h,g;const m=this.requireLib("path");let S;return((t=this.syProcess())==null?void 0:t.platform)==="darwin"?S=m.join((n=this.syProcess())==null?void 0:n.env.HOME,"/Library/Application Support"):((c=this.syProcess())==null?void 0:c.platform)==="win32"?S=(u=this.syProcess())==null?void 0:u.env.APPDATA:((h=this.syProcess())==null?void 0:h.platform)==="linux"&&(S=(g=this.syProcess())==null?void 0:g.env.HOME),S}),this.siyuanUtil=new G}copyFolderSync(t,n){const c=this,u=this.requireLib("fs"),h=this.requireLib("path");u.existsSync(n)||u.mkdirSync(n),u.lstatSync(t).isDirectory()&&u.readdirSync(t).forEach(function(g){const m=h.join(t,g);u.lstatSync(m).isDirectory()?c.copyFolderSync(m,h.join(n,g)):u.copyFileSync(m,h.join(n,g))})}rmFolder(t){const n=this.requireLib("fs");n.existsSync(t)&&n.rmdirSync(t,{recursive:!0})}joinPath(...t){return this.requireLib("path").join(...t)}dirname(t){return this.requireLib("path").dirname(t)}absPath(t){const n=this.requireLib("path"),c=this.dirname(t);return n.resolve(n.dirname(c),t)}syProcess(){return b.isInBrowser?window.process:process}siyuanConfPath(){const t=this.siyuanUtil.siyuanWindow();if(!t)throw new Error("Not in siyuan env");return t==null?void 0:t.siyuan.config.system.confDir}siyuanDataPath(){const t=this.siyuanUtil.siyuanWindow();if(!t)throw new Error("Not in siyuan env");return t.siyuan.config.system.dataDir}siyuanAppearancePath(){return this.requireLib("path").join(this.siyuanConfPath(),"appearance")}siyuanThemePath(){return this.requireLib("path").join(this.siyuanAppearancePath(),"themes")}zhiThemePath(){return this.requireLib("path").join(this.siyuanThemePath(),"zhi")}zhiThemeDistPath(){return this.requireLib("path").join(this.zhiThemePath(),"apps","theme","dist")}zhiBlogDistPath(){return this.requireLib("path").join(this.siyuanThemePath(),"apps","blog","dist")}zhiMiniPath(){return this.requireLib("path").join(this.siyuanThemePath(),"zhi-mini")}}class Ie{constructor(){a(this,"strUtil"),a(this,"dateUtil"),a(this,"electronUtil"),a(this,"browserUtil"),a(this,"versionUtil"),a(this,"deviceUtil"),this.strUtil=new we,this.dateUtil=new ye,this.electronUtil=new be,this.browserUtil=b,this.versionUtil=new Ee,this.deviceUtil=Se}}class Oe{constructor(t){a(this,"env"),a(this,"logger"),a(this,"siyuanApi"),a(this,"blogApi"),a(this,"common"),this.env=t,this.logger=j.defaultLogger(this.env,J.LOG_STACK_SIZE),this.siyuanApi=new fe,this.blogApi=new de,this.common=new Ie}getEnv(){if(!this.env)throw new Error("env is not initiated, please use new ZhiSdk(env) create ZhiSdk object!");return this.env}getLogger(){return this.logger}}const P=class{static zhiSdk(l){if(!P.zhiSdkObj){P.zhiSdkObj=new Oe(l);const t=P.zhiSdkObj.getLogger(),n=P.zhiSdkObj.common;t.info(n.strUtil.f("ZhiSdk inited, components are available now,like logger, env and so on."))}return P.zhiSdkObj}};let V=P;M(V,"zhiSdkObj");const version="1.0.0";var i=Object.defineProperty,v=(l,t,n)=>t in l?i(l,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):l[t]=n,r=(l,t,n)=>(v(l,typeof t!="symbol"?t+"":t,n),n);class s{}r(s,"NODE_ENV_KEY","NODE_ENV"),r(s,"VITE_DEBUG_MODE_KEY","VITE_DEBUG_MODE");class o{constructor(t){r(this,"envMeta"),this.envMeta=t}isNodeDev(){return this.getEnv(s.NODE_ENV_KEY)==="development"}isDev(){return this.isNodeDev()||this.getBooleanEnv(s.VITE_DEBUG_MODE_KEY)}getEnv(t){let n;try{this.envMeta[t]&&(n=this.envMeta[t])}catch(c){console.error(c)}return n}getStringEnv(t){return this.getEnv(t)??""}getBooleanEnv(t){let n=!1;return this.getEnv(t)&&(n=this.getStringEnv(t).toLowerCase()==="true"),n}getEnvOrDefault(t,n){const c=this.getStringEnv(t);return c.trim().length==0?n:c}}class HackPluginSystem{constructor(){T(this,"logger");T(this,"common");T(this,"siyuanApi");T(this,"ZHI_PLUGIN_FOLDER","zhi-plugins");T(this,"PLUGIN_FOLDER","plugins");T(this,"MANIFEST","manifest.json");T(this,"OLD_VERSION_ZERO","0.0.0");T(this,"SCRIPT","main.js");T(this,"getFileContent",async l=>{const t=this.common.electronUtil.requireLib("fs");return new Promise((n,c)=>{t.readFile(l,(u,h)=>{if(u){c(u);return}return n(h.toString("utf8"))})})});T(this,"getManifest",async l=>{const t=await this.getFileContent(l);try{return JSON.parse(t)}catch(n){return this.logger.error("Lading manifest: "+l,n),null}});T(this,"getPluginSystem",()=>this.siyuanApi.siyuanUtil.siyuanWindow().pluginSystem);T(this,"getPluginSystemVersion",()=>this.siyuanApi.siyuanUtil.siyuanWindow().pluginSystemVersion);const l=new o({VITE_LOG_LEVEL:"INFO",VITE_DEBUG_MODE:"true",BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1}),t=V.zhiSdk(l);this.logger=t.getLogger(),this.common=t.common,this.siyuanApi=t.siyuanApi}isDir(l){return this.common.electronUtil.requireLib("fs").statSync(l).isDirectory()}isExists(l){try{return this.common.electronUtil.requireLib("fs").statSync(l),!0}catch{return!1}}async scanPlugins(l){const t=this,n=this.common.electronUtil.requireLib("fs"),c=this.common.electronUtil.requireLib("path");return new Promise((u,h)=>{n.readdir(l,(g,m)=>{var S;if(g){t.logger.error(g),u([]);return}u(((S=m.filter(d=>this.isDir(c.join(l,d))&&this.isExists(c.join(l,d,t.MANIFEST))&&this.isExists(c.join(l,d,t.SCRIPT))))==null?void 0:S.map(d=>c.resolve(l,d)))||[])})})}async initPluginSystem(){const pluginSystem=this.getPluginSystem();if(pluginSystem){this.logger.warn("Plugin system already loaded by snapshots, ignore initiation."),this.logger.warn("Loaded plugin system version is ",this.getPluginSystemVersion());return}try{this.logger.info("Undetected plugin system，initiating plugin system...");const fs=this.common.electronUtil.requireLib("fs"),path=this.common.electronUtil.requireLib("path"),data=fs.readFileSync(path.join(this.common.electronUtil.getCrossPlatformAppDataFolder(),".siyuan","plugin.js")),script=data.toString("utf8");this.logger.info("Local plugin system found, loading..."),eval(script)}catch(e){this.logger.info("Local plugin system not found, load online"),this.logger.debug("Plugin system Load error",e);const res=await fetch("https://gitee.com/zuoez02/siyuan-plugin-system/raw/main/main.js",{cache:"no-cache"}),sc=await res.text();this.siyuanApi.siyuanUtil.siyuanWindow().siyuanPluginScript=sc,eval(sc)}const sys=this.getPluginSystem(),sysv=this.getPluginSystemVersion()??"unknown";return this.logger.info(this.common.strUtil.f("Plugin system inited, version => {0}.",sysv)),Promise.resolve(sys)}}class PluginSystemHook{constructor(){T(this,"logger");T(this,"common");T(this,"siyuanApi");T(this,"hack");const t=new o({VITE_LOG_LEVEL:"INFO",VITE_DEBUG_MODE:"true",BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1}),n=V.zhiSdk(t);this.logger=n.getLogger(),this.common=n.common,this.siyuanApi=n.siyuanApi,this.hack=new HackPluginSystem}getOldPluginInfo(t,n){let c=!1,u=!1,h=this.hack.OLD_VERSION_ZERO;const g=t.pslm.storageMangager.thirdPartyPlugins;for(const m of g)n.name===m.name&&(this.common.versionUtil.greater(n.version,m.version)&&(u=!0),h=m.version,c=!0);return{isSynced:c,oldVersion:h,isUpdate:u}}async syncZhiPlugins(t){this.logger.info("Start syncing zhi plugins ...");const n=this.common.electronUtil.requireLib("fs"),c=this.common.electronUtil.requireLib("path"),u=this.common.electronUtil.joinPath(this.common.electronUtil.zhiThemePath(),"apps","theme","lib",this.hack.ZHI_PLUGIN_FOLDER);this.logger.debug("Zhi plugins folder=>",u);const h=this.common.electronUtil.joinPath(this.common.electronUtil.siyuanDataPath(),this.hack.PLUGIN_FOLDER);this.logger.debug("Plugins folder=>",h);let g=0,m=[];if(!n.existsSync(u))this.logger.warn("No zhi plugins found, stop!");else{m=await this.hack.scanPlugins(u);for(const S of m){const d=c.basename(S),p=S,y=c.join(h,d);this.logger.debug(this.common.strUtil.f("Try syncing zhi plugin {0}",d));const L=await this.hack.getManifest(c.join(S,this.hack.MANIFEST)),_=this.getOldPluginInfo(t,L),q=_.oldVersion;if(this.logger.info(this.common.strUtil.f("Plugin status : [{0}] isSynced=>{1}, isUpdate=>{2}, forceUpdate=>{3}, version Info: {4} -> {5}",d,_.isSynced,_.isUpdate,L.forceUpdate,q,L.version)),_.isSynced)if(_.isSynced&&_.isUpdate){if(!n.existsSync(y))throw new Error(this.common.strUtil.f("Conflict plugin exists, manifest exists but dest folder is not correct with original, please fix plugin folder name.Expected forder is=>{0}",y));this.common.strUtil.f("Do syncing, please wait..."),this.common.electronUtil.copyFolderSync(p,y),g++}else L.forceUpdate?(this.logger.warn(this.common.strUtil.f("Find forceUpdate flag in manifest.json, try forcing update plugin, [{0}] {1}.This flag is development only, before publish plugin, you should remove this flag from manifest.json!",d,L.version)),this.common.electronUtil.rmFolder(y),this.common.electronUtil.copyFolderSync(p,y),g++):this.logger.debug(this.common.strUtil.f("Already synced and the latest version [{0}] {1}",d,L.version));else{if(n.existsSync(y))throw new Error(this.common.strUtil.f("Expected forder already exists=>{0}",y));this.common.strUtil.f("Do syncing, please wait..."),this.common.electronUtil.copyFolderSync(p,y),g++}}}this.logger.info(this.common.strUtil.f("Zhi theme plugins Synced.Scaned {0}, synced {1} plugin(s).",m.length,g)),g>0&&this.logger.warn(this.common.strUtil.f("Synced {0} zhi plugins, you need to reload siyuan to take effect.",g))}async init(){const t=await this.hack.initPluginSystem();if(!t){this.logger.error("Plugin system init error, some feature may not work!");return}await this.syncZhiPlugins(t),this.logger.info("PluginSystem inited.")}}class PluginSystem{async initPluginSystem(){return await new PluginSystemHook().init(),Promise.resolve([])}}const pluginSystem=new PluginSystem;class Lifecycle{constructor(){T(this,"_dynamicImports",[])}get dynamicImports(){return this._dynamicImports}async load(){const t=[],n=await this.loadPluginSystem(),c=await this.loadWidgets(),u=await this.loadVendors();this._dynamicImports=t.concat(n).concat(c).concat(u)}async loadPluginSystem(){return await pluginSystem.initPluginSystem()}async loadWidgets(){return Promise.resolve([])}async loadVendors(){return Promise.resolve([])}}const Pe=class{static async start(){return await Pe.lifecycle.load(),Promise.resolve(Pe.lifecycle.dynamicImports)}};let Bootstrap=Pe;T(Bootstrap,"lifecycle"),(()=>{Pe.lifecycle=new Lifecycle})();class Zhi{constructor(){T(this,"logger");T(this,"common");const t=new o({VITE_LOG_LEVEL:"INFO",VITE_DEBUG_MODE:"true",BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1}),n=V.zhiSdk(t);this.logger=n.getLogger(),this.common=n.common}async main(t){return this.logger.debug(this.common.strUtil.f("Parsing args <{0}>",t)),this.hello(re.ThemeFrom_Siyuan),await Bootstrap.start()}hello(t){this.logger.info(this.common.strUtil.f("Hello, {0} {1} v{2}! You are from {3}","zhi","theme",version,t))}}class Theme{constructor(){T(this,"logger");T(this,"common");T(this,"siyuanApi");T(this,"zhiTheme");const t=new o({VITE_LOG_LEVEL:"INFO",VITE_DEBUG_MODE:"true",BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1}),n=V.zhiSdk(t);this.logger=n.getLogger(),this.common=n.common,this.siyuanApi=n.siyuanApi,this.zhiTheme=new Zhi}async init(t){try{const n=await this.zhiTheme.main([]);for(const c of n){const u=c.libpath;if(c.format!=="cjs"||!u.includes(".cjs")){this.logger.warn("Only cjs supported, skip this lib!",u);continue}if(t&&t!==c.runAs){this.logger.warn(this.common.strUtil.f("This lib can only run at {0}, skip!Lib is=>{1}",c.runAs,c.libpath));continue}this.logger.info("Loading dependency=>",u);let h;if(this.common.browserUtil.isInBrowser){const g=this.common.electronUtil.joinPath(this.common.electronUtil.zhiMiniPath(),u);h=this.common.electronUtil.requireLib(g)}h&&h.init&&await h.init()}this.logger.info("Theme inited.")}catch(n){this.logger.error("Theme load error=>",n)}}}var callsitesExports={},callsites$1={get exports(){return callsitesExports},set exports(l){callsitesExports=l}};const callsites=()=>{const l=Error.prepareStackTrace;Error.prepareStackTrace=(n,c)=>c;const t=new Error().stack.slice(1);return Error.prepareStackTrace=l,t};callsites$1.exports=callsites;callsitesExports.default=callsites;(async()=>{const l=new o({VITE_LOG_LEVEL:"INFO",VITE_DEBUG_MODE:"true",BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1}),n=V.zhiSdk(l).getLogger(),c=async()=>{n.debug("Theme is loading..."),await new Theme().init("electron"),n.debug("Theme loaded.")};if(l.isDev()){const u=callsitesExports(),h="theme.js";(u.length>0?u[0].getFileName()??h:h).includes(h)?await import("http://localhost:5173/theme.ts"):await c()}else await c()})();
