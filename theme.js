"use strict";var Te=Object.defineProperty;var De=(n,t,i)=>t in n?Te(n,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):n[t]=i;var E=(n,t,i)=>(De(n,typeof t!="symbol"?t+"":t,i),i);var ee=Object.defineProperty,te=(n,t,i)=>t in n?ee(n,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):n[t]=i,M=(n,t,i)=>(te(n,typeof t!="symbol"?t+"":t,i),i),re=(n=>(n.ThemeFrom_Blog="zhi-theme-blog",n.ThemeFrom_Siyuan="zhi-theme-siyuan",n))(re||{}),ne=Object.defineProperty,ie=(n,t,i)=>t in n?ne(n,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):n[t]=i,a=(n,t,i)=>(ie(n,typeof t!="symbol"?t+"":t,i),i),oe=Object.defineProperty,se=(n,t,i)=>t in n?oe(n,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):n[t]=i,U=(n,t,i)=>(se(n,typeof t!="symbol"?t+"":t,i),i),X=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},x={},ae={get exports(){return x},set exports(n){x=n}};(function(n){(function(t,i){n.exports?n.exports=i():t.log=i()})(X,function(){var t=function(){},i="undefined",o=typeof window!==i&&typeof window.navigator!==i&&/Trident\/|MSIE /.test(window.navigator.userAgent),s=["trace","debug","info","warn","error"];function r(m,S){var L=m[S];if(typeof L.bind=="function")return L.bind(m);try{return Function.prototype.bind.call(L,m)}catch{return function(){return Function.prototype.apply.apply(L,[m,arguments])}}}function l(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function c(m){return m==="debug"&&(m="log"),typeof console===i?!1:m==="trace"&&o?l:console[m]!==void 0?r(console,m):console.log!==void 0?r(console,"log"):t}function u(m,S){for(var L=0;L<s.length;L++){var y=s[L];this[y]=L<m?t:this.methodFactory(y,m,S)}this.log=this.debug}function h(m,S,L){return function(){typeof console!==i&&(u.call(this,S,L),this[m].apply(this,arguments))}}function g(m,S,L){return c(m)||h.apply(this,arguments)}function d(m,S,L){var y=this,C;S=S??"WARN";var v="loglevel";typeof m=="string"?v+=":"+m:typeof m=="symbol"&&(v=void 0);function q(f){var _=(s[f]||"silent").toUpperCase();if(!(typeof window===i||!v)){try{window.localStorage[v]=_;return}catch{}try{window.document.cookie=encodeURIComponent(v)+"="+_+";"}catch{}}}function B(){var f;if(!(typeof window===i||!v)){try{f=window.localStorage[v]}catch{}if(typeof f===i)try{var _=window.document.cookie,D=_.indexOf(encodeURIComponent(v)+"=");D!==-1&&(f=/^([^;]+)/.exec(_.slice(D))[1])}catch{}return y.levels[f]===void 0&&(f=void 0),f}}function W(){if(!(typeof window===i||!v)){try{window.localStorage.removeItem(v);return}catch{}try{window.document.cookie=encodeURIComponent(v)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}y.name=m,y.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},y.methodFactory=L||g,y.getLevel=function(){return C},y.setLevel=function(f,_){if(typeof f=="string"&&y.levels[f.toUpperCase()]!==void 0&&(f=y.levels[f.toUpperCase()]),typeof f=="number"&&f>=0&&f<=y.levels.SILENT){if(C=f,_!==!1&&q(f),u.call(y,f,m),typeof console===i&&f<y.levels.SILENT)return"No console available for logging"}else throw"log.setLevel() called with invalid level: "+f},y.setDefaultLevel=function(f){S=f,B()||y.setLevel(f,!1)},y.resetLevel=function(){y.setLevel(S,!1),W()},y.enableAll=function(f){y.setLevel(y.levels.TRACE,f)},y.disableAll=function(f){y.setLevel(y.levels.SILENT,f)};var T=B();T==null&&(T=S),y.setLevel(T,!1)}var p=new d,w={};p.getLogger=function(m){if(typeof m!="symbol"&&typeof m!="string"||m==="")throw new TypeError("You must supply a name when creating a logger.");var S=w[m];return S||(S=w[m]=new d(m,p.getLevel(),p.methodFactory)),S};var R=typeof window!==i?window.log:void 0;return p.noConflict=function(){return typeof window!==i&&window.log===p&&(window.log=R),p},p.getLoggers=function(){return w},p.default=p,p})})(ae);var A={},le={get exports(){return A},set exports(n){A=n}};(function(n){(function(t,i){n.exports?n.exports=i():t.prefix=i(t)})(X,function(t){var i=function(g){for(var d=1,p=arguments.length,w;d<p;d++)for(w in arguments[d])Object.prototype.hasOwnProperty.call(arguments[d],w)&&(g[w]=arguments[d][w]);return g},o={template:"[%t] %l:",levelFormatter:function(g){return g.toUpperCase()},nameFormatter:function(g){return g||"root"},timestampFormatter:function(g){return g.toTimeString().replace(/.*(\d{2}:\d{2}:\d{2}).*/,"$1")},format:void 0},s,r={},l=function(g){if(!g||!g.getLogger)throw new TypeError("Argument is not a root logger");s=g},c=function(g,d){if(!g||!g.setLevel)throw new TypeError("Argument is not a logger");var p=g.methodFactory,w=g.name||"",R=r[w]||r[""]||o;function m(S,L,y){var C=p(S,L,y),v=r[y]||r[""],q=v.template.indexOf("%t")!==-1,B=v.template.indexOf("%l")!==-1,W=v.template.indexOf("%n")!==-1;return function(){for(var T="",f=arguments.length,_=Array(f),D=0;D<f;D++)_[D]=arguments[D];if(w||!r[y]){var Pe=v.timestampFormatter(new Date),Ue=v.levelFormatter(S),_e=v.nameFormatter(y);v.format?T+=v.format(Ue,_e,Pe):(T+=v.template,q&&(T=T.replace(/%t/,Pe)),B&&(T=T.replace(/%l/,Ue)),W&&(T=T.replace(/%n/,_e))),_.length&&typeof _[0]=="string"?_[0]=T+" "+_[0]:_.unshift(T)}C.apply(void 0,_)}}return r[w]||(g.methodFactory=m),d=d||{},d.template&&(d.format=void 0),r[w]=i({},R,d),g.setLevel(g.getLevel()),s||g.warn("It is necessary to call the function reg() of loglevel-plugin-prefix before calling apply. From the next release, it will throw an error. See more: https://github.com/kutuluk/loglevel-plugin-prefix/blob/master/README.md"),g},u={reg:l,apply:c},h;return t&&(h=t.prefix,u.noConflict=function(){return t.prefix===u&&(t.prefix=h),u}),u})})(le);class k{}U(k,"LOG_LEVEL_KEY","VITE_LOG_LEVEL"),U(k,"LOG_PREFIX_KEY","VITE_LOG_PREFIX");var O=(n=>(n.LOG_LEVEL_DEBUG="DEBUG",n.LOG_LEVEL_INFO="INFO",n.LOG_LEVEL_WARN="WARN",n.LOG_LEVEL_ERROR="ERROR",n))(O||{});function ce(){const n=Error.prepareStackTrace;Error.prepareStackTrace=(i,o)=>o;const t=new Error().stack.slice(1);return Error.prepareStackTrace=n,t}class N{static stringToEnumValue(t,i){return t[Object.keys(t).filter(o=>t[o].toString()===i)[0]]}static getEnvLevel(t){if(!t)return;const i=t.getEnvOrDefault(k.LOG_LEVEL_KEY,O.LOG_LEVEL_INFO),o=N.stringToEnumValue(O,i.toUpperCase());return o||console.warn("[zhi-log] LOG_LEVEL is invalid in you .env file.Must be either debug, info, warn or error, fallback to default info level"),o}static getEnvLogger(t){if(t)return t.getEnv(k.LOG_PREFIX_KEY)}}class ue{constructor(t,i,o){U(this,"consoleLogger","console"),U(this,"stackSize",1),U(this,"getLogger",l=>{let c;if(l)c=l;else{const u=ce(),h=[];for(let g=0;g<u.length;g++){const d=u[g],p=d.getFileName()??"none";if(!p.includes(".ts")&&!p.includes(".js")&&!p.includes(".cjs")&&!p.includes(".mjs")&&!p.includes(".vue")&&!p.includes(".tsx"))continue;if(g>this.stackSize-1)break;const w=p+"-"+d.getLineNumber()+":"+d.getColumnNumber();h.push(w)}u.length>0&&(c=h.join(" -> "))}return(!c||c.trim().length===0)&&(c=this.consoleLogger),x.getLogger(c)}),this.stackSize=1;let s;t?s=t:s=N.getEnvLevel(o),s=s??O.LOG_LEVEL_INFO,x.setLevel(s);const r={gray:l=>l.toString(),green:l=>l.toString(),yellow:l=>l.toString(),red:l=>l.toString()};A.reg(x),A.apply(x,{format(l,c,u){const h=["["+(i??N.getEnvLogger(o)??"zhi")+"]"];switch(h.push(r.gray("[")+r.green(u).toString()+r.gray("]")),l){case O.LOG_LEVEL_DEBUG:h.push(r.gray(l.toUpperCase().toString()));break;case O.LOG_LEVEL_INFO:h.push(r.green(l.toUpperCase().toString()));break;case O.LOG_LEVEL_WARN:h.push(r.yellow(l.toUpperCase().toString()));break;case O.LOG_LEVEL_ERROR:h.push(r.red(l.toUpperCase().toString()));break}return h.push(r.green(c).toString()),h.push(r.gray(":")),h.join(" ")}})}setStackSize(t){this.stackSize=t??1}}class he{constructor(t,i,o){U(this,"logger"),this.logger=new ue(t,i,o)}getLogger(t,i){return this.logger.setStackSize(i),this.logger.getLogger(t)}}class Z extends he{constructor(t,i,o){super(t,i,o)}getLogger(t,i){return super.getLogger(t,i)}}class V{static defaultLogger(t,i){return V.customLogFactory(void 0,void 0,t).getLogger(void 0,i)}static customLogFactory(t,i,o){return new Z(t,i,o)}static customSignLogFactory(t,i){return new Z(void 0,t,i)}}class J{}a(J,"LOG_STACK_SIZE",1);const Q="1.0.10";class ge{constructor(){a(this,"VERSION"),this.VERSION=Q}}class pe{constructor(){a(this,"VERSION"),this.VERSION=Q}}const I=class{constructor(){a(this,"getQueryString",n=>{if(!I.isInBrowser)return"";const t=window.location.search.substring(1).split("&");for(let i=0;i<t.length;i++){const o=t[i].split("=");if(o[0]===n)return o[1]}return""})}static isInChromeExtension(){return I.isInBrowser?window.location.href.indexOf("chrome-extension://")>-1:!1}};let b=I;a(b,"isInBrowser",typeof window<"u"),a(b,"isElectron",()=>!I.isInBrowser||!window.navigator||!window.navigator.userAgent?!1:/Electron/.test(window.navigator.userAgent)),a(b,"replaceUrlParam",(n,t,i)=>{i==null&&(i="");const o=new RegExp("\\b("+t+"=).*?(&|#|$)");return n.search(o)>=0?n.replace(o,"$1"+i+"$2"):(n=n.replace(/[?#]$/,""),n+(n.indexOf("?")>0?"&":"?")+t+"="+i)}),a(b,"setUrlParameter",(n,t,i)=>I.isInBrowser?n.includes(t)?I.replaceUrlParam(n,t,i):(n+=(n.match(/[?]/g)!=null?"&":"?")+t+"="+i,n):""),a(b,"reloadTabPage",n=>{setTimeout(function(){if(I.isInBrowser){const t=window.location.href;window.location.href=I.setUrlParameter(t,"tab",n)}},200)}),a(b,"reloadPage",()=>{setTimeout(function(){I.isInBrowser&&window.location.reload()},200)}),a(b,"reloadPageWithMessageCallback",(n,t)=>{t&&t(),setTimeout(function(){I.isInBrowser&&window.location.reload()},200)});class G{constructor(){a(this,"isInSiyuanWidget",()=>typeof window>"u"?!1:window.frameElement!=null&&window.frameElement.parentElement!=null&&window.frameElement.parentElement.parentElement!=null&&window.frameElement.parentElement.parentElement.getAttribute("data-node-id")!==""),a(this,"isInSiyuanNewWin",()=>typeof window>"u"?!1:typeof window.terwer<"u"),a(this,"isInSiyuanOrSiyuanNewWin",()=>b.isElectron)}siyuanWindow(){let t;return this.isInSiyuanWidget()?t=parent.window:this.isInSiyuanNewWin()||typeof window<"u"?t=window:t=void 0,t}}class fe{constructor(){a(this,"serverApi"),a(this,"clientApi"),a(this,"siyuanUtil"),this.serverApi=new ge,this.clientApi=new pe,this.siyuanUtil=new G}}class de{constructor(){a(this,"VERSION"),this.VERSION="1.0.0"}}class we{f(t,...i){let o=t;for(let s=0;s<i.length;s++){const r=i[s];typeof r=="string"?o=o.replace(`{${s}}`,r):o=o.replace(`{${s}}`,r.toString())}return o}}class ye{constructor(){a(this,"TIME_SPLIT"," "),a(this,"formatIsoToZhDate",(t,i,o)=>{if(!t)return"";let s=t;const r=/(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})(.\d{3})Z$/gm,l=s.match(r);if(l==null)return t;for(let c=0;c<l.length;c++){const u=l[c];let h=u;i&&(h=this.addHoursToDate(new Date(u),8).toISOString());const g=h.split("T"),d=g[0],p=g[1].split(".")[0];let w=d+this.TIME_SPLIT+p;o&&(w=d),s=s.replace(u,w)}return s})}addHoursToDate(t,i){return t.setTime(t.getTime()+i*60*60*1e3),t}nowZh(){return this.formatIsoToZhDate(new Date().toISOString())}nowDateZh(){return this.formatIsoToZhDate(new Date().toISOString(),!0,!0)}nowTimeZh(){return this.formatIsoToZhDate(new Date().toISOString(),!0).split(this.TIME_SPLIT)[1]}}const j=(n,t)=>{const i=$(n),o=$(t),s=i.pop(),r=o.pop(),l=H(i,o);return l!==0?l:s&&r?H(s.split("."),r.split(".")):s||r?s?-1:1:0},me=/^[v^~<>=]*?(\d+)(?:\.([x*]|\d+)(?:\.([x*]|\d+)(?:\.([x*]|\d+))?(?:-([\da-z\-]+(?:\.[\da-z\-]+)*))?(?:\+[\da-z\-]+(?:\.[\da-z\-]+)*)?)?)?$/i,$=n=>{if(typeof n!="string")throw new TypeError("Invalid argument expected string");const t=n.match(me);if(!t)throw new Error(`Invalid argument not valid semver ('${n}' received)`);return t.shift(),t},K=n=>n==="*"||n==="x"||n==="X",Y=n=>{const t=parseInt(n,10);return isNaN(t)?n:t},ve=(n,t)=>typeof n!=typeof t?[String(n),String(t)]:[n,t],Le=(n,t)=>{if(K(n)||K(t))return 0;const[i,o]=ve(Y(n),Y(t));return i>o?1:i<o?-1:0},H=(n,t)=>{for(let i=0;i<Math.max(n.length,t.length);i++){const o=Le(n[i]||"0",t[i]||"0");if(o!==0)return o}return 0};class Ee{greater(t,i){return j(t,i)>0}equal(t,i){return j(t,i)===0}lesser(t,i){return j(t,i)<0}}class Se{static getDevice(){const t=new G;return t.isInSiyuanWidget()?"Siyuan_Widget":t.isInSiyuanOrSiyuanNewWin()?"Siyuan_NewWin":b.isInChromeExtension()?"Chrome_Extension":"Chrome_Browser"}}class be{constructor(){a(this,"siyuanUtil"),a(this,"requireLib",t=>{const i=this.siyuanUtil.siyuanWindow();return i?i.require(t):require(t)}),a(this,"getCrossPlatformAppDataFolder",()=>{var t,i,o,s,r,l;const c=this.requireLib("path");let u;return((t=this.syProcess())==null?void 0:t.platform)==="darwin"?u=c.join((i=this.syProcess())==null?void 0:i.env.HOME,"/Library/Application Support"):((o=this.syProcess())==null?void 0:o.platform)==="win32"?u=(s=this.syProcess())==null?void 0:s.env.APPDATA:((r=this.syProcess())==null?void 0:r.platform)==="linux"&&(u=(l=this.syProcess())==null?void 0:l.env.HOME),u}),this.siyuanUtil=new G}copyFolderSync(t,i){const o=this,s=this.requireLib("fs"),r=this.requireLib("path");s.existsSync(i)||s.mkdirSync(i),s.lstatSync(t).isDirectory()&&s.readdirSync(t).forEach(function(l){const c=r.join(t,l);s.lstatSync(c).isDirectory()?o.copyFolderSync(c,r.join(i,l)):s.copyFileSync(c,r.join(i,l))})}rmFolder(t){const i=this.requireLib("fs");i.existsSync(t)&&i.rmdirSync(t,{recursive:!0})}joinPath(...t){return this.requireLib("path").join(...t)}dirname(t){return this.requireLib("path").dirname(t)}absPath(t){const i=this.requireLib("path"),o=this.dirname(t);return i.resolve(i.dirname(o),t)}syProcess(){return b.isInBrowser?window.process:process}siyuanConfPath(){const t=this.siyuanUtil.siyuanWindow();if(!t)throw new Error("Not in siyuan env");return t==null?void 0:t.siyuan.config.system.confDir}siyuanDataPath(){const t=this.siyuanUtil.siyuanWindow();if(!t)throw new Error("Not in siyuan env");return t.siyuan.config.system.dataDir}siyuanAppearancePath(){return this.requireLib("path").join(this.siyuanConfPath(),"appearance")}siyuanThemePath(){return this.requireLib("path").join(this.siyuanAppearancePath(),"themes")}zhiThemePath(){return this.requireLib("path").join(this.siyuanThemePath(),"zhi")}zhiThemeDistPath(){return this.requireLib("path").join(this.zhiThemePath(),"apps","theme","dist")}zhiBlogDistPath(){return this.requireLib("path").join(this.siyuanThemePath(),"apps","blog","dist")}zhiMiniPath(){return this.requireLib("path").join(this.siyuanThemePath(),"zhi-mini")}}class Ie{constructor(){a(this,"strUtil"),a(this,"dateUtil"),a(this,"electronUtil"),a(this,"browserUtil"),a(this,"versionUtil"),a(this,"deviceUtil"),this.strUtil=new we,this.dateUtil=new ye,this.electronUtil=new be,this.browserUtil=b,this.versionUtil=new Ee,this.deviceUtil=Se}}class Oe{constructor(t){a(this,"env"),a(this,"logger"),a(this,"siyuanApi"),a(this,"blogApi"),a(this,"common"),this.env=t,this.logger=V.defaultLogger(this.env,J.LOG_STACK_SIZE),this.siyuanApi=new fe,this.blogApi=new de,this.common=new Ie}getEnv(){if(!this.env)throw new Error("env is not initiated, please use new ZhiSdk(env) create ZhiSdk object!");return this.env}getLogger(){return this.logger}}const P=class{static zhiSdk(n){if(!P.zhiSdkObj){P.zhiSdkObj=new Oe(n);const t=P.zhiSdkObj.getLogger(),i=P.zhiSdkObj.common;t.info(i.strUtil.f("ZhiSdk inited, components are available now,like logger, env and so on."))}return P.zhiSdkObj}};let z=P;M(z,"zhiSdkObj");const version="1.0.0";function getDefaultExportFromCjs(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var lib={};(function(n){var t=Object.defineProperty,i=(l,c,u)=>c in l?t(l,c,{enumerable:!0,configurable:!0,writable:!0,value:u}):l[c]=u,o=(l,c,u)=>(i(l,typeof c!="symbol"?c+"":c,u),u);Object.defineProperties(n,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});class s{}o(s,"NODE_ENV_KEY","NODE_ENV"),o(s,"VITE_DEBUG_MODE_KEY","VITE_DEBUG_MODE");class r{constructor(c){o(this,"envMeta"),this.envMeta=c}isNodeDev(){return this.getEnv(s.NODE_ENV_KEY)==="development"}isDev(){return this.isNodeDev()||this.getBooleanEnv(s.VITE_DEBUG_MODE_KEY)}getEnv(c){let u;try{this.envMeta[c]&&(u=this.envMeta[c])}catch(h){console.error(h)}return u}getStringEnv(c){return this.getEnv(c)??""}getBooleanEnv(c){let u=!1;return this.getEnv(c)&&(u=this.getStringEnv(c).toLowerCase()==="true"),u}getEnvOrDefault(c,u){const h=this.getStringEnv(c);return h.trim().length==0?u:h}}n.EnvConstants=s,n.default=r})(lib);const Env=getDefaultExportFromCjs(lib);class HackPluginSystem{constructor(){E(this,"logger");E(this,"common");E(this,"siyuanApi");E(this,"ZHI_PLUGIN_FOLDER","zhi-plugins");E(this,"PLUGIN_FOLDER","plugins");E(this,"MANIFEST","manifest.json");E(this,"OLD_VERSION_ZERO","0.0.0");E(this,"SCRIPT","main.js");E(this,"getFileContent",async n=>{const t=this.common.electronUtil.requireLib("fs");return new Promise((i,o)=>{t.readFile(n,(s,r)=>{if(s){o(s);return}return i(r.toString("utf8"))})})});E(this,"getManifest",async n=>{const t=await this.getFileContent(n);try{return JSON.parse(t)}catch(i){return this.logger.error("Lading manifest: "+n,i),null}});E(this,"getPluginSystem",()=>this.siyuanApi.siyuanUtil.siyuanWindow().pluginSystem);E(this,"getPluginSystemVersion",()=>this.siyuanApi.siyuanUtil.siyuanWindow().pluginSystemVersion);const n=new Env({VITE_LOG_LEVEL:"INFO",VITE_DEBUG_MODE:"true",BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1}),t=z.zhiSdk(n);this.logger=t.getLogger(),this.common=t.common,this.siyuanApi=t.siyuanApi}isDir(n){return this.common.electronUtil.requireLib("fs").statSync(n).isDirectory()}isExists(n){try{return this.common.electronUtil.requireLib("fs").statSync(n),!0}catch{return!1}}async scanPlugins(n){const t=this,i=this.common.electronUtil.requireLib("fs"),o=this.common.electronUtil.requireLib("path");return new Promise((s,r)=>{i.readdir(n,(l,c)=>{var u;if(l){t.logger.error(l),s([]);return}s(((u=c.filter(h=>this.isDir(o.join(n,h))&&this.isExists(o.join(n,h,t.MANIFEST))&&this.isExists(o.join(n,h,t.SCRIPT))))==null?void 0:u.map(h=>o.resolve(n,h)))||[])})})}async initPluginSystem(){const pluginSystem=this.getPluginSystem();if(pluginSystem){this.logger.warn("Plugin system already loaded by snapshots, ignore initiation."),this.logger.warn("Loaded plugin system version is ",this.getPluginSystemVersion());return}try{this.logger.info("Undetected plugin system，initiating plugin system...");const fs=this.common.electronUtil.requireLib("fs"),path=this.common.electronUtil.requireLib("path"),data=fs.readFileSync(path.join(this.common.electronUtil.getCrossPlatformAppDataFolder(),".siyuan","plugin.js")),script=data.toString("utf8");this.logger.info("Local plugin system found, loading..."),eval(script)}catch(e){this.logger.info("Local plugin system not found, load online"),this.logger.debug("Plugin system Load error",e);const res=await fetch("https://gitee.com/zuoez02/siyuan-plugin-system/raw/main/main.js",{cache:"no-cache"}),sc=await res.text();this.siyuanApi.siyuanUtil.siyuanWindow().siyuanPluginScript=sc,eval(sc)}const sys=this.getPluginSystem(),sysv=this.getPluginSystemVersion()??"unknown";return this.logger.info(this.common.strUtil.f("Plugin system inited, version => {0}.",sysv)),Promise.resolve(sys)}}class PluginSystemHook{constructor(){E(this,"logger");E(this,"common");E(this,"siyuanApi");E(this,"hack");const t=new Env({VITE_LOG_LEVEL:"INFO",VITE_DEBUG_MODE:"true",BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1}),i=z.zhiSdk(t);this.logger=i.getLogger(),this.common=i.common,this.siyuanApi=i.siyuanApi,this.hack=new HackPluginSystem}getOldPluginInfo(t,i){let o=!1,s=!1,r=this.hack.OLD_VERSION_ZERO;const l=t.pslm.storageMangager.thirdPartyPlugins;for(const c of l)i.name===c.name&&(this.common.versionUtil.greater(i.version,c.version)&&(s=!0),r=c.version,o=!0);return{isSynced:o,oldVersion:r,isUpdate:s}}async syncZhiPlugins(t){this.logger.info("Start syncing zhi plugins ...");const i=this.common.electronUtil.requireLib("fs"),o=this.common.electronUtil.requireLib("path"),s=this.common.electronUtil.joinPath(this.common.electronUtil.zhiThemePath(),"lib",this.hack.ZHI_PLUGIN_FOLDER);this.logger.debug("Zhi plugins folder=>",s);const r=this.common.electronUtil.joinPath(this.common.electronUtil.siyuanDataPath(),this.hack.PLUGIN_FOLDER);this.logger.debug("Plugins folder=>",r);let l=0,c=[];if(!i.existsSync(s))this.logger.warn("No zhi plugins found, stop!");else{c=await this.hack.scanPlugins(s);for(const u of c){const h=o.basename(u),g=u,d=o.join(r,h);this.logger.debug(this.common.strUtil.f("Try syncing zhi plugin {0}",h));const p=await this.hack.getManifest(o.join(u,this.hack.MANIFEST)),w=this.getOldPluginInfo(t,p),R=w.oldVersion;if(this.logger.info(this.common.strUtil.f("Plugin status : [{0}] isSynced=>{1}, isUpdate=>{2}, forceUpdate=>{3}, version Info: {4} -> {5}",h,w.isSynced,w.isUpdate,p.forceUpdate,R,p.version)),w.isSynced)if(w.isSynced&&w.isUpdate){if(!i.existsSync(d))throw new Error(this.common.strUtil.f("Conflict plugin exists, manifest exists but dest folder is not correct with original, please fix plugin folder name.Expected forder is=>{0}",d));this.common.strUtil.f("Do syncing, please wait..."),this.common.electronUtil.copyFolderSync(g,d),l++}else p.forceUpdate?(this.logger.warn(this.common.strUtil.f("Find forceUpdate flag in manifest.json, try forcing update plugin, [{0}] {1}.This flag is development only, before publish plugin, you should remove this flag from manifest.json!",h,p.version)),this.common.electronUtil.rmFolder(d),this.common.electronUtil.copyFolderSync(g,d),l++):this.logger.debug(this.common.strUtil.f("Already synced and the latest version [{0}] {1}",h,p.version));else{if(i.existsSync(d))throw new Error(this.common.strUtil.f("Expected forder already exists=>{0}",d));this.common.strUtil.f("Do syncing, please wait..."),this.common.electronUtil.copyFolderSync(g,d),l++}}}this.logger.info(this.common.strUtil.f("Zhi theme plugins Synced.Scaned {0}, synced {1} plugin(s).",c.length,l)),l>0&&this.logger.warn(this.common.strUtil.f("Synced {0} zhi plugins, you need to reload siyuan to take effect.",l))}async init(){const t=await this.hack.initPluginSystem();if(!t){this.logger.error("Plugin system init error, some feature may not work!");return}await this.syncZhiPlugins(t),this.logger.info("PluginSystem inited.")}}class PluginSystem{async initPluginSystem(){return await new PluginSystemHook().init(),Promise.resolve([])}}const pluginSystem=new PluginSystem;class Lifecycle{constructor(){E(this,"_dynamicImports",[])}get dynamicImports(){return this._dynamicImports}async load(){const t=[],i=await this.loadPluginSystem(),o=await this.loadWidgets(),s=await this.loadVendors();this._dynamicImports=t.concat(i).concat(o).concat(s)}async loadPluginSystem(){return await pluginSystem.initPluginSystem()}async loadWidgets(){return Promise.resolve([])}async loadVendors(){return Promise.resolve([])}}const F=class{static async start(){return await F.lifecycle.load(),Promise.resolve(F.lifecycle.dynamicImports)}};let Bootstrap=F;E(Bootstrap,"lifecycle"),(()=>{F.lifecycle=new Lifecycle})();class Zhi{constructor(){E(this,"logger");E(this,"common");const t=new Env({VITE_LOG_LEVEL:"INFO",VITE_DEBUG_MODE:"true",BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1}),i=z.zhiSdk(t);this.logger=i.getLogger(),this.common=i.common}async main(t){return this.logger.debug(this.common.strUtil.f("Parsing args <{0}>",t)),this.hello(re.ThemeFrom_Siyuan),await Bootstrap.start()}hello(t){this.logger.info(this.common.strUtil.f("Hello, {0} {1} v{2}! You are from {3}","zhi","theme",version,t))}}class Theme{constructor(){E(this,"logger");E(this,"common");E(this,"siyuanApi");E(this,"zhiTheme");const t=new Env({VITE_LOG_LEVEL:"INFO",VITE_DEBUG_MODE:"true",BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1}),i=z.zhiSdk(t);this.logger=i.getLogger(),this.common=i.common,this.siyuanApi=i.siyuanApi,this.zhiTheme=new Zhi}async init(t){try{const i=await this.zhiTheme.main([]);for(const o of i){const s=o.libpath;if(o.format!=="cjs"||!s.includes(".cjs")){this.logger.warn("Only cjs supported, skip this lib!",s);continue}if(t&&t!==o.runAs){this.logger.warn(this.common.strUtil.f("This lib can only run at {0}, skip!Lib is=>{1}",o.runAs,o.libpath));continue}this.logger.info("Loading dependency=>",s);let r;if(this.common.browserUtil.isInBrowser){const l=this.common.electronUtil.joinPath(this.common.electronUtil.zhiMiniPath(),s);r=this.common.electronUtil.requireLib(l)}r&&r.init&&await r.init()}this.logger.info("Theme inited.")}catch(i){this.logger.error("Theme load error=>",i)}}}var callsitesExports={},callsites$1={get exports(){return callsitesExports},set exports(n){callsitesExports=n}};const callsites=()=>{const n=Error.prepareStackTrace;Error.prepareStackTrace=(i,o)=>o;const t=new Error().stack.slice(1);return Error.prepareStackTrace=n,t};callsites$1.exports=callsites;callsitesExports.default=callsites;(async()=>{const n=new Env({VITE_LOG_LEVEL:"INFO",VITE_DEBUG_MODE:"true",BASE_URL:"/",MODE:"production",DEV:!1,PROD:!0,SSR:!1}),i=z.zhiSdk(n).getLogger(),o=async()=>{i.debug("Theme is loading..."),await new Theme().init("electron"),i.debug("Theme loaded.")};if(n.isDev()){const s=callsitesExports(),r="theme.js";(s.length>0?s[0].getFileName()??r:r).includes(r)?await import("http://localhost:5173/theme.ts"):await o()}else await o()})();
